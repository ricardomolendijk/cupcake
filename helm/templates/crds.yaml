{{- if .Values.crds.install }}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: directupdates.cupcake.ricardomolendijk.com
  annotations:
    "helm.sh/resource-policy": {{ .Values.crds.keep | ternary "keep" "delete" }}
spec:
  group: cupcake.ricardomolendijk.com
  names:
    kind: DirectUpdate
    listKind: DirectUpdateList
    plural: directupdates
    singular: directupdate
    shortNames:
      - du
  scope: Cluster
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - targetVersion
              properties:
                targetVersion:
                  type: string
                  description: "Kubernetes version e.g. 1.27.4"
                components:
                  type: array
                  items:
                    type: string
                    enum:
                      - kubeadm
                      - kubelet
                      - kubectl
                      - containerd
                      - etcd
                  description: "Components to upgrade"
                  default:
                    - kubeadm
                    - kubelet
                    - kubectl
                strategy:
                  type: string
                  enum:
                    - rolling
                    - parallel
                    - canary
                  default: rolling
                  description: "Upgrade strategy"
                concurrency:
                  type: integer
                  minimum: 1
                  default: 1
                  description: "Number of worker nodes to upgrade concurrently"
                canary:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                    nodes:
                      type: array
                      items:
                        type: string
                      description: "List of node names for canary deployment"
                nodeSelector:
                  type: object
                  additionalProperties:
                    type: string
                  description: "Node selector to filter nodes for upgrade"
                preflightChecks:
                  type: boolean
                  default: true
                  description: "Run preflight checks before upgrade"
                airGapped:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                    bundleConfigMap:
                      type: string
                      description: "ConfigMap containing air-gapped bundle information"
                dryRun:
                  type: boolean
                  default: false
                  description: "Perform dry-run without actual changes"
                operationTimeout:
                  type: string
                  default: "2h"
                  description: "Maximum time for the entire operation (e.g., 2h, 30m)"
                nodeTimeout:
                  type: string
                  default: "30m"
                  description: "Maximum time per node operation"
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum:
                    - Pending
                    - InProgress
                    - Succeeded
                    - Failed
                    - RequiresAttention
                    - Cancelled
                operationID:
                  type: string
                  description: "Unique identifier for this operation"
                startedAt:
                  type: string
                  format: date-time
                lastUpdated:
                  type: string
                  format: date-time
                completedAt:
                  type: string
                  format: date-time
                message:
                  type: string
                  description: "Human-readable status message"
                nodes:
                  type: object
                  additionalProperties:
                    type: object
                    properties:
                      phase:
                        type: string
                        enum:
                          - Pending
                          - Draining
                          - Upgrading
                          - Verifying
                          - Uncordoning
                          - Completed
                          - Failed
                      lastStep:
                        type: string
                        description: "Last completed step"
                      startedAt:
                        type: string
                        format: date-time
                      lastUpdated:
                        type: string
                        format: date-time
                      completedAt:
                        type: string
                        format: date-time
                      message:
                        type: string
                        description: "Status message for this node"
                      error:
                        type: string
                        description: "Error message if failed"
                summary:
                  type: object
                  properties:
                    total:
                      type: integer
                    completed:
                      type: integer
                    upgrading:
                      type: integer
                    pending:
                      type: integer
                    failed:
                      type: integer
                preflightResults:
                  type: object
                  properties:
                    passed:
                      type: boolean
                    checks:
                      type: array
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          passed:
                            type: boolean
                          message:
                            type: string
                upgradePath:
                  type: object
                  description: "Multi-step upgrade path information"
                  properties:
                    currentVersion:
                      type: string
                      description: "Starting version"
                    targetVersion:
                      type: string
                      description: "Final target version"
                    steps:
                      type: array
                      items:
                        type: string
                      description: "Ordered list of versions to upgrade through"
                    currentStep:
                      type: integer
                      description: "Current step in the upgrade path (0-indexed)"
                    totalSteps:
                      type: integer
                      description: "Total number of upgrade steps"

                backupInfo:
                  type: object
                  properties:
                    etcdSnapshot:
                      type: string
                      description: "Location of etcd snapshot"
                    timestamp:
                      type: string
                      format: date-time
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Target
          type: string
          jsonPath: .spec.targetVersion
        - name: Progress
          type: string
          jsonPath: .status.summary.completed
          description: "Completed/Total nodes"
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: scheduledupdates.cupcake.ricardomolendijk.com
  annotations:
    "helm.sh/resource-policy": {{ .Values.crds.keep | ternary "keep" "delete" }}
spec:
  group: cupcake.ricardomolendijk.com
  names:
    kind: ScheduledUpdate
    listKind: ScheduledUpdateList
    plural: scheduledupdates
    singular: scheduledupdate
    shortNames:
      - su
  scope: Cluster
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - targetVersion
                - scheduleAt
              properties:
                targetVersion:
                  type: string
                  description: "Kubernetes version e.g. 1.27.4"
                scheduleAt:
                  type: string
                  format: date-time
                  description: "When to start the upgrade"
                components:
                  type: array
                  items:
                    type: string
                  default:
                    - kubeadm
                    - kubelet
                    - kubectl
                strategy:
                  type: string
                  enum:
                    - rolling
                    - parallel
                    - canary
                  default: rolling
                concurrency:
                  type: integer
                  minimum: 1
                  default: 1
                canary:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                    nodes:
                      type: array
                      items:
                        type: string
                nodeSelector:
                  type: object
                  additionalProperties:
                    type: string
                preflightChecks:
                  type: boolean
                  default: true
                airGapped:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                    bundleConfigMap:
                      type: string
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum:
                    - Scheduled
                    - Executing
                    - Completed
                    - Failed
                    - Cancelled
                scheduledFor:
                  type: string
                  format: date-time
                executedAt:
                  type: string
                  format: date-time
                directUpdateName:
                  type: string
                  description: "Name of created DirectUpdate CR"
                message:
                  type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Target
          type: string
          jsonPath: .spec.targetVersion
        - name: Scheduled
          type: string
          jsonPath: .spec.scheduleAt
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: updateschedules.cupcake.ricardomolendijk.com
  annotations:
    "helm.sh/resource-policy": {{ .Values.crds.keep | ternary "keep" "delete" }}
spec:
  group: cupcake.ricardomolendijk.com
  names:
    kind: UpdateSchedule
    listKind: UpdateScheduleList
    plural: updateschedules
    singular: updateschedule
    shortNames:
      - us
  scope: Cluster
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - schedule
                - updatePolicy
              properties:
                schedule:
                  type: string
                  description: "Cron expression for schedule"
                  pattern: '^(@(annually|yearly|monthly|weekly|daily|hourly|reboot))|(@every (\d+(ns|us|µs|ms|s|m|h))+)|((((\d+,)+\d+|(\d+(\/|-)\d+)|\d+|\*) ?){5,7})$'
                updatePolicy:
                  type: object
                  required:
                    - targetVersionPattern
                  properties:
                    targetVersionPattern:
                      type: string
                      description: "Version pattern, e.g., 1.27.* or latest-patch"
                    components:
                      type: array
                      items:
                        type: string
                      default:
                        - kubeadm
                        - kubelet
                    strategy:
                      type: string
                      enum:
                        - rolling
                        - parallel
                        - canary
                      default: rolling
                    concurrency:
                      type: integer
                      minimum: 1
                      default: 1
                    preflightChecks:
                      type: boolean
                      default: true
                suspended:
                  type: boolean
                  default: false
                  description: "Suspend scheduled updates"
                maintenanceWindow:
                  type: object
                  properties:
                    start:
                      type: string
                      description: "Start time (HH:MM format)"
                    end:
                      type: string
                      description: "End time (HH:MM format)"
                    timezone:
                      type: string
                      default: "UTC"
            status:
              type: object
              properties:
                lastScheduledTime:
                  type: string
                  format: date-time
                nextScheduledTime:
                  type: string
                  format: date-time
                lastUpdateName:
                  type: string
                  description: "Name of last created ScheduledUpdate"
                active:
                  type: integer
                  description: "Number of active scheduled updates"
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Schedule
          type: string
          jsonPath: .spec.schedule
        - name: Suspended
          type: boolean
          jsonPath: .spec.suspended
        - name: Last Schedule
          type: string
          jsonPath: .status.lastScheduledTime
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
{{- end }}
